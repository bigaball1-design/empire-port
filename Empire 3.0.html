<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Empire Port 3.4</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #070707; --card: #111; --text: #eee; --dim: #888; --up: #00ff88; --down: #ff3344; --accent: #222; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 15px; }
        header { border-bottom: 2px solid var(--accent); padding-bottom: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-family: 'JetBrains Mono'; font-size: 1.4rem; color: var(--up); margin: 0; }
        .summary-bar { background: var(--card); border: 1px solid var(--accent); padding: 20px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; border-radius: 10px; }
        .summary-item span { display: block; font-size: 0.7rem; color: var(--dim); margin-bottom: 4px; text-transform: uppercase; }
        .summary-item b { font-family: 'JetBrains Mono'; font-size: 1.3rem; }
        .charts-wrapper { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; margin-bottom: 25px; }
        .chart-box { background: var(--card); border: 1px solid var(--accent); padding: 20px; border-radius: 10px; height: 350px; }
        .list-header, .stock-row { display: grid; grid-template-columns: 1.2fr 0.8fr 0.8fr 0.8fr 1fr 1fr 1.2fr; gap: 10px; align-items: center; }
        .list-header { padding: 0 15px 12px; color: var(--dim); font-size: 0.65rem; text-transform: uppercase; font-weight: 700; }
        .stock-row { background: var(--card); border: 1px solid var(--accent); margin-bottom: 10px; padding: 18px 15px; border-radius: 8px; font-size: 1rem; }
        .ticker-info b { font-family: 'JetBrains Mono'; font-size: 1.1rem; color: var(--up); display: block; }
        .ticker-info i { font-size: 0.7rem; color: var(--dim); display: block; font-style: normal; }
        .p-box b { display: block; font-size: 1rem; font-family: 'JetBrains Mono'; }
        .p-box i { font-size: 0.75rem; color: var(--dim); font-style: normal; }
        .bar-bg { height: 6px; background: #222; border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--up); width: 0%; transition: 1.2s; }
        .up { color: var(--up) !important; } .down { color: var(--down) !important; }
        .white { color: #ffffff !important; }
        @media (max-width: 900px) { .charts-wrapper { grid-template-columns: 1fr; } .list-header { display: none; } .stock-row { grid-template-columns: 1.2fr 1fr; gap: 15px; } .chart-box { height: 320px; } }
    </style>
</head>
<body>
    <header><h1>EMPIRE_PORT_3.4</h1><div id="sync-info" style="font-size: 0.6rem; color: var(--dim);">SYSTEM_READY</div></header>
    <div class="summary-bar">
        <div class="summary-item"><span>Net Worth (USD)</span><b id="total-usd">$0</b></div>
        <div class="summary-item"><span>Net Worth (THB)</span><b id="total-thb">฿0</b></div>
        <div class="summary-item"><span>Total Unrealized P/L</span><b id="total-pl">0.00%</b></div>
        <div class="summary-item"><span>USD/THB (Live)</span><b id="fx-rate">0.00</b></div>
    </div>
    <div class="charts-wrapper">
        <div class="chart-box"><div style="font-size:0.75rem; color:var(--dim); margin-bottom:10px">// ALLOCATION_WEIGHT</div><canvas id="pieChart"></canvas></div>
        <div class="chart-box"><div style="font-size:0.75rem; color:var(--dim); margin-bottom:10px">// GROWTH_TRACKER</div><canvas id="growthChart"></canvas></div>
    </div>
    <div class="list-header"><div>Asset</div><div>Shares</div><div>Avg Cost</div><div>Price</div><div>Value</div><div>P/L</div><div>Target</div></div>
    <div id="stock-list"></div>

<script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTQxEdO_NiXSTfy_96k0yL4rm-i9Ap3PwsIAzm4D3UlUVuntBqanNjChBCfB-ylKgWvYYI6kxIThfk-/pub?gid=1701656193&single=true&output=csv';
    let LIVE_FX = 36.50, myGChart = null, myPChart = null;

    function clean(v) { if(!v || v=="#N/A") return 0; return parseFloat(v.toString().replace(/[^0-9.-]+/g, "")) || 0; }

    async function update() {
        try {
            const fx = await fetch('https://open.er-api.com/v6/latest/USD').then(r => r.json());
            LIVE_FX = fx.rates.THB;
            const text = await fetch(CSV_URL).then(r => r.text());
            const rows = text.split('\n').slice(1).map(r => r.split(',')).filter(r => r[0] && clean(r[5]) > 0);
            render(rows);
        } catch (e) { document.getElementById('sync-info').innerText = "SYNC_ERROR"; }
    }

    function render(rows) {
        const container = document.getElementById('stock-list');
        container.innerHTML = '';
        let tMkt = 0, tCost = 0, tTarget = 0, tickers = [], values = [];

        rows.forEach(cols => {
            const ticker = cols[0].trim(), price = clean(cols[2]), cost = clean(cols[4]), shares = clean(cols[5]), target = clean(cols[7]);
            const mktVal = price * shares, costBasis = cost * shares, plUsd = mktVal - costBasis;
            const plPct = costBasis > 0 ? (plUsd / costBasis) * 100 : 0;
            const progress = target > 0 ? Math.min((price / target) * 100, 100) : 0;
            
            tMkt += mktVal; tCost += costBasis; tTarget += (target * shares);
            tickers.push(ticker); values.push(mktVal);

            container.innerHTML += `<div class="stock-row">
                <div class="ticker-info"><b>${ticker}</b><i>${cols[1]}</i></div>
                <div class="p-box"><b>${shares.toLocaleString()}</b><i>shares</i></div>
                <div class="p-box"><b>$${cost.toFixed(2)}</b></div>
                <div class="p-box"><b>$${price.toFixed(2)}</b><i>฿${(price*LIVE_FX).toFixed(2)}</i></div>
                <div class="p-box"><b class="white">$${mktVal.toLocaleString(undefined,{maximumFractionDigits:0})}</b><i>฿${(mktVal*LIVE_FX).toLocaleString(undefined,{maximumFractionDigits:0})}</i></div>
                <div class="p-box"><b class="${plUsd>=0?'up':'down'}">${plUsd>=0?'+':'-'}$${Math.abs(plUsd).toLocaleString(undefined,{maximumFractionDigits:0})}</b><i class="${plUsd>=0?'up':'down'}">${plPct.toFixed(1)}%</i></div>
                <div><div style="display:flex; justify-content:space-between; font-size:0.6rem; color:var(--dim)"><span>TGT $${target}</span><span>${progress.toFixed(0)}%</span></div><div class="bar-bg"><div class="bar-fill" style="width:${progress}%"></div></div></div>
            </div>`;
        });

        document.getElementById('total-usd').innerText = `$${tMkt.toLocaleString(undefined,{maximumFractionDigits:0})}`;
        document.getElementById('total-thb').innerText = `฿${(tMkt*LIVE_FX).toLocaleString(undefined,{maximumFractionDigits:0})}`;
        const totalPlPct = tCost > 0 ? ((tMkt - tCost) / tCost) * 100 : 0;
        document.getElementById('total-pl').innerText = `${totalPlPct>=0?'+':''}${totalPlPct.toFixed(2)}%`;
        document.getElementById('total-pl').className = totalPlPct >= 0 ? 'up' : 'down';
        document.getElementById('fx-rate').innerText = LIVE_FX.toFixed(2);
        document.getElementById('sync-info').innerText = `LAST_SYNC: ${new Date().toLocaleTimeString()}`;
        
        drawCharts(tMkt, tTarget, tickers, values);
    }

    function drawCharts(current, target, tickers, values) {
        if (myGChart) myGChart.destroy();
        myGChart = new Chart(document.getElementById('growthChart'), {
            type: 'line',
            data: { labels: ['Now','W1','W2','W3','W4','W5','Target'], datasets: [
                { data: Array(7).fill(target), borderColor: '#00ff88', borderDash: [5,5], pointRadius: 0, fill: false },
                { data: Array(7).fill(current), borderColor: '#444', backgroundColor: 'rgba(255,255,255,0.05)', fill: true, pointRadius: 0 }
            ]},
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#222' }, ticks: { color: '#aaa' }, suggestedMin: current*0.9 } } }
        });

        const total = values.reduce((a, b) => a + b, 0);
        const pieLabels = tickers.map((t, i) => `${t} (${((values[i]/total)*100).toFixed(1)}%)`);

        if (myPChart) myPChart.destroy();
        myPChart = new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: { labels: pieLabels, datasets: [{ data: values, backgroundColor: ['#FFADAD', '#FFD6A5', '#FDFFB6', '#CAFFBF', '#9BF6FF', '#A0C4FF', '#BDB2FF', '#FFC6FF'], borderWidth: 0 }]},
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#aaa', font: { size: 16 } } } }, cutout: '70%' }
        });
    }
    update(); setInterval(update, 60000);
</script>
</body>
</html>
